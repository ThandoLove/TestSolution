@page "/contacts"
@attribute [Authorize]
@using OutlookBlazorTestApp2.Services
@inject IJSRuntime JS
@inject HttpClient Http
@inject AuthStateService AuthState
@inject SageX3Service SageX3  // ✅ Inject Sage X3 service for creating contacts


<h3 class="mb-3">Contacts</h3>

<AuthorizeView>
    <Authorized>
        <!-- ⬅️ Button to open modal -->
        <button class="btn btn-primary" @onclick="ShowModal">
            + Create Contact from Email
        </button>
    </Authorized>
    <NotAuthorized>
        <div class="alert alert-warning mt-3">
            Please sign in to manage contacts.
        </div>
    </NotAuthorized>
</AuthorizeView>

<!-- ✅ START: Modal -->
@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Create Contact from Email</h5>
                    <button type="button" class="btn-close" @onclick="HideModal"></button>
                </div>

                <div class="modal-body">
                    <!-- ✅ Replace your old fields with your CreateContactRequest fields -->

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">First Name</label>
                            <input class="form-control" @bind="contact.FirstName" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Name</label>
                            <input class="form-control" @bind="contact.LastName" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" @bind="contact.Email" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" @bind="contact.Phone" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Company</label>
                        <input class="form-control" @bind="contact.Company" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input class="form-control" @bind="contact.Title" />
                    </div>

                    <h5 class="mt-3">Primary Address</h5>

                    <div class="mb-3">
                        <label class="form-label">Street</label>
                        <input class="form-control" @bind="contact.PrimaryAddress.Street" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">City</label>
                        <input class="form-control" @bind="contact.PrimaryAddress.City" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">State</label>
                        <input class="form-control" @bind="contact.PrimaryAddress.State" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Postal Code</label>
                        <input class="form-control" @bind="contact.PrimaryAddress.PostalCode" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Country</label>
                        <input class="form-control" @bind="contact.PrimaryAddress.Country" />
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="HideModal">Cancel</button>

                    <!-- Option 1: Save to API -->
                    <button class="btn btn-success me-2" @onclick="CreateContact">
                        Save to API
                    </button>

                    <!-- Option 2: Save to Sage X3 -->
                    <button class="btn btn-primary" @onclick="SaveContactToSageX3">
                        Save to Sage X3
                    </button>
                </div>

            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}
<!-- ✅ END: Modal -->

<!-- ✅ Toast -->
@if (toastVisible)
{
    <div class="toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3 show">
        <div class="d-flex">
            <div class="toast-body">
                Contact created successfully!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    @onclick="() => toastVisible = false"></button>
        </div>
    </div>
}

@code {
    // ✅ Keep same logic, just use CreateContactRequest model
    private bool showModal;
    private bool toastVisible;
    private CreateContactRequest contact = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var email = await JS.InvokeAsync<EmailDto>("getEmailContext");
            contact.Email = email.from;
            contact.FirstName = ExtractName(email.from);
        }
        catch
        {
            // fallback if not running in Outlook
            contact.Email = "test@example.com";
        }
    }

    private string ExtractName(string email)
        => email.Split('@')[0].Replace('.', ' ').CapitalizeWords();

    record EmailDto(string from);

    private void ShowModal() => showModal = true;
    private void HideModal() => showModal = false;

    // ✅ Adjust the endpoint to match your controller
    private async Task CreateContact()
    {
        try
        {
            var response = await Http.PostAsJsonAsync("api/contact/create-contact", contact);

            if (response.IsSuccessStatusCode)
            {
                showModal = false;
                toastVisible = true;
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to create contact.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            await JS.InvokeVoidAsync("alert", "Error creating contact.");
        }
    }

    // ✅ NEW: Save contact directly to Sage X3
    private async Task SaveContactToSageX3()
    {
        try
        {
            var contactJson = await SageX3.CreateContactAsync(
                contact.FirstName + " " + contact.LastName,
                contact.Email,
                contact.Phone,
                contact.Company,
                contact.Title,
                contact.PrimaryAddress); // send the full contact info

            Console.WriteLine($"✅ Created in Sage X3: {contactJson}");

            // Close modal & show toast
            showModal = false;
            toastVisible = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            await JS.InvokeVoidAsync("alert", "Error creating contact in Sage X3.");
        }
    }


    // ✅ Import your model here
    public class Address
    {
        public string Street { get; set; } = "";
        public string City { get; set; } = "";
        public string State { get; set; } = "";
        public string PostalCode { get; set; } = "";
        public string Country { get; set; } = "";
    }

    public class CreateContactRequest
    {
        [Required]
        [StringLength(100)]
        public string FirstName { get; set; } = "";

        [Required]
        [StringLength(100)]
        public string LastName { get; set; } = "";

        [EmailAddress]
        public string Email { get; set; } = "";

        [Phone]
        public string Phone { get; set; } = "";

        public string Company { get; set; } = "";
        public string Title { get; set; } = "";
        public Address PrimaryAddress { get; set; } = new();
    }
}
